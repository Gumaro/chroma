#
TOPDIR=@top_srcdir@
BUILDDIR=@top_builddir@

#
# Include Path
#
INCFLAGS=-I$(TOPDIR)/lib -I$(BUILDDIR)/lib

#
# Any other compiler flags
#
AM_CXXFLAGS = $(INCFLAGS) @QDPXX_CXXFLAGS@ @BAGEL_WILSON_DSLASH_CXXFLAGS@ @GMP_CXXFLAGS@ @CXXFLAGS@
AM_LDFLAGS = -L$(BUILDDIR)/lib @QDPXX_LDFLAGS@ @BAGEL_WILSON_DSLASH_LDFLAGS@ @GMP_LDFLAGS@ @LDFLAGS@
LDADD = -lchroma @QDPXX_LIBS@ @BAGEL_WILSON_DSLASH_LIBS@ @GMP_LIBS@ @LIBS@

if BUILD_SSE_WILSON_DSLASH
AM_CXXFLAGS += -I$(TOPDIR)/other_libs/@SSE_DSLASH_DIR@/include -I$(BUILDDIR)/other_libs/@SSE_DSLASH_DIR@/include
AM_LDFLAGS += -L$(BUILDDIR)/other_libs/@SSE_DSLASH_DIR@/lib
LDADD += -llevel3 @QDPXX_LIBS@
endif

if BUILD_SSE_DWF_CG
AM_CXXFLAGS += -I$(TOPDIR)/other_libs/@SSE_DWF_CG_DIR@/include
AM_LDFLAGS += -L$(BUILDDIR)/other_libs/@SSE_DWF_CG_DIR@/lib
LDADD += -lsse_dwf_cg 
endif

#
# Local Headers
#
HDRS =

## Production tests:
bin_PROGRAMS = t_mesplq t_lwldslash_sse t_lwldslash_pab t_ritz_KS t_lwldslash_array

#
# add the programs to build in here
# 
## NOTE: if you want the programs to be build by default when 'make' is run
##   add them to bin_PROGRAMS.  But, if you don't want them to be installed
##   in @prefix@/bin by 'make install' then add them to nodist_PROGRAMS.
##   Another option is to add it to check_PROGRAMS, which means it will only
##   be built by 'make check' and is not installed.
check_PROGRAMS  = t_io t_mesons_w  t_conslinop t_hypsmear \
    t_ape_smear t_precact t_dwf4d t_propagator_s t_disc_loop_s \
    t_remez t_ritz t_dwflocality

## Moved t_dslashm and t_lwldslash to EXTRA_PROGRAMS because they currently
## do not compile.  This way, they don't break 'make check' but the targets
## 'make t_dslashm' and 'make t_lwldslash' are still there for further
## development

EXTRA_PROGRAMS  = t_dslashm t_lwldslash t_spprod \
    t_follana_io_s t_formfac  t_follana_pion_s t_dwflinop t_precdwf \
    t_ovlap_bj t_propagator_s t_propagator_w t_gfix t_ovlap5d_bj \
    t_ritz5d_KS  t_fermion_loop_w t_propagator_fuzz_s t_propagator_fuzz_baryon_s\
    t_disc_loop_s t_ov_pbp t_propagator_nrqcd \
    t_invert3_precwilson t_invert4_precwilson t_read_eigen \
    t_fuzwilp t_ovlap_double_pass t_g5eps_bj t_sumr t_msumr t_invrelcg t_bicgstab \
    t_wilslp t_rel_gmresr t_invborici t_hamsys t_hamsys_ferm \
    t_precact_sse t_preccfz_opt \
    t_hmc_pg t_neflinop t_prec_contfrac t_mres_4d t_prec_nef t_su3 \
    t_overbu t_lower_tests t_seqsource \
    t_unprec_wilson_force t_prec_wilson_force t_unprec_twoflav_wilson_monomial \
    t_prec_twoflav_wilson_monomial t_hamiltonian t_leapfrog t_hmc \
    t_propagator_twisted \
    t_gauge_force \
    t_circular_buffer \
    t_precnef \
    t_preccfz \
    t_stout_state

#
# The programs and their dependencies
#
## GTF NOTE: It's getting kind of tedious listing a t_progname_DEPENDENCIES
##   for each target program.  Why doesn't it work to just replace them all
##   with a single 'check_DEPENDENCIES = build_chroma_libs'?  Must rtfm.
##   Also, DEPENDENCIES seems to be a documented feature only
##   in automake-1.7x but seems to do the right thing for automake-1.6x.
##   Worth investigating.
##
## check_DEPENDENCIES = build_chroma_libs

t_su3_SOURCES = t_su3.cc
t_mesplq_SOURCES = t_mesplq.cc
t_seqsource_SOURCES = t_seqsource.cc
t_remez_SOURCES = t_remez.cc
t_ape_smear_SOURCES = t_ape_smear.cc
t_lower_tests_SOURCES = t_lower_tests.cc
t_fuzwilp_SOURCES = t_fuzwilp.cc
t_wilslp_SOURCES = t_wilslp.cc
t_hypsmear_SOURCES = t_hypsmear.cc
t_dslashm_SOURCES = t_dslashm.cc
t_io_SOURCES = t_io.cc
t_lwldslash_SOURCES = t_lwldslash.cc
t_dwflinop_SOURCES = t_dwflinop.cc
t_dwf4d_SOURCES = t_dwf4d.cc
t_precact_SOURCES = t_precact.cc
t_precdwf_SOURCES = t_precdwf.cc
t_formfac_SOURCES = t_formfac.cc
t_mesons_w_SOURCES = t_mesons_w.cc
t_conslinop_SOURCES = t_conslinop.cc
t_overbu_SOURCES = t_overbu.cc
t_spprod_SOURCES = t_spprod.cc
t_follana_io_s_SOURCES = t_follana_io_s.cc
t_follana_pion_s_SOURCES = t_follana_pion_s.cc
t_lwldslash_sse_SOURCES = t_lwldslash_sse.cc
t_lwldslash_pab_SOURCES = t_lwldslash_pab.cc
t_ovlap_bj_SOURCES = t_ovlap_bj.cc
t_ovlap_double_pass_SOURCES = t_ovlap_double_pass.cc
t_g5eps_bj_SOURCES = t_g5eps_bj.cc
t_sumr_SOURCES = t_sumr.cc
t_rel_gmresr_SOURCES = t_rel_gmresr.cc
t_msumr_SOURCES = t_msumr.cc
t_invrelcg_SOURCES = t_invrelcg.cc
t_neflinop_SOURCES = t_neflinop.cc
t_ovlap5d_bj_SOURCES = t_ovlap5d_bj.cc

t_propagator_s_SOURCES = t_propagator_s.cc
t_disc_loop_s_SOURCES = t_disc_loop_s.cc
t_propagator_fuzz_s_SOURCES = t_propagator_fuzz_s.cc
t_propagator_fuzz_baryon_s_SOURCES = t_propagator_fuzz_baryon_s.cc
t_propagator_w_SOURCES = t_propagator_w.cc

t_propagator_twisted_SOURCES = t_propagator_twisted.cc
t_propagator_nrqcd_SOURCES = t_propagator_nrqcd.cc
t_fermion_loop_w_SOURCES = t_fermion_loop_w.cc

t_gfix_SOURCES = t_gfix.cc
t_ritz_SOURCES = t_ritz.cc
t_ritz_KS_SOURCES = t_ritz_KS.cc
t_ritz5d_KS_SOURCES = t_ritz5d_KS.cc
t_ov_pbp_SOURCES = t_ov_pbp.cc
t_dwflocality_SOURCES = t_dwflocality.cc
t_invert3_precwilson_SOURCES = t_invert3_precwilson.cc
t_invert4_precwilson_SOURCES = t_invert4_precwilson.cc invcg2_timing_hacks_2.h invcg2_timing_hacks_2.cc invcg2_prec_wilson.h invcg2_prec_wilson.cc

t_read_eigen_SOURCES = t_read_eigen.cc
t_bicgstab_SOURCES = t_bicgstab.cc
t_invborici_SOURCES = t_invborici.cc
t_hamsys_SOURCES = t_hamsys.cc
t_hamsys_ferm_SOURCES = t_hamsys_ferm.cc
t_hmc_pg_SOURCES = t_hmc_pg.cc
t_precact_sse_SOURCES = t_precact_sse.cc
t_preccfz_opt_SOURCES = t_preccfz_opt.cc
t_prec_contfrac_SOURCES = t_prec_contfrac.cc
t_mres_4d_SOURCES = t_mres_4d.cc
t_prec_nef_SOURCES = t_prec_nef.cc
t_unprec_wilson_force_SOURCES = t_unprec_wilson_force.cc
t_prec_wilson_force_SOURCES = t_prec_wilson_force.cc
t_unprec_twoflav_wilson_monomial_SOURCES = t_unprec_twoflav_wilson_monomial.cc
t_prec_twoflav_wilson_monomial_SOURCES = t_prec_twoflav_wilson_monomial.cc
t_hamiltonian_SOURCES = t_hamiltonian.cc
t_leapfrog_SOURCES = t_leapfrog.cc
t_hmc_SOURCES = t_hmc.cc
t_gauge_force_SOURCES = t_gauge_force.cc
t_circular_buffer_SOURCES = t_circular_buffer.cc
t_precnef_SOURCES = t_precnef.cc
t_preccfz_SOURCES = t_preccfz.cc
t_lwldslash_array_SOURCES = t_lwldslash_array.cc
t_stout_state_SOURCES = t_stout_state.cc

# build lib is a target that goes to the build dir of the library and 
# does a make to make sure all those dependencies are OK. In order
# for it to be done every time, we have to make it a 'phony' target

DEPENDENCIES = build_chroma_libs rebuild_other_libs
${bin_PROGRAMS}: ${DEPENDENCIES}
${check_PROGRAMS}: ${DEPENDENCIES}
${EXTRA_PROGRAMS}: ${DEPENDENCIES}

.PHONY: build_chroma_libs
build_chroma_libs:
	cd $(BUILDDIR)/lib ; $(MAKE)

.PHONY: rebuild_other_libs
rebuild_other_libs:
	cd $(BUILDDIR)/other_libs ; $(MAKE)

# xmldiff targets
.PHONY: xcheck
xcheck:
	perl ../../scripts/run_xmldiff.pl
